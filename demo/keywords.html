<head>
    <title>Tokchi Keywords Demo</title>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="../css/tokchi.css">
    <link rel="stylesheet" type="text/css" href="keywords.css">
    <script type="text/javascript" src="http://cdn.jsdelivr.net/jquery/3.0.0-alpha1/jquery.min.js"></script>
    <script type="application/javascript" src="../src/jquery.tokchi.js"></script>
    <script type="application/javascript">
        $(document).ready(function() {
            $('#search').tokchify({
                dropdownStyle: 'follows',
                onReady(tokchi) {
                    window.tokchi = tokchi;
                },
                onPressReturn(tokchi) {
                    $('#selection').text(JSON.stringify(tokchi.getValue()));
                    return true;
                },
                onPressSpace(tokchi) {
                    if (tokchi._currentSearchNode.textContent.trim()) {
                        tokchi.addToken({
                            id: Math.floor(Math.random()),
                            label: tokchi._currentSearchNode.textContent
                        });
                    }

                    return true;
                },
                onCreateToken(tokchi, tokenHTMLNode, tokenObj) {
                    $(tokenHTMLNode).append(
                        $('<div>').text(tokenObj.label)
                    );
                },
                onChange(tokchi) {
                    console.debug('Did change');
                    var tokens = tokchi.getTokens();
                    var sel = '';

                    tokens.forEach(function(token) {
                        if(sel) sel += ', ';
                        sel += token.label + ' (ID=' + token.id + ')';
                    });

                    $('#selection').text(sel ? ('Selection = ' + sel) : '');
                },
                onCreateDropdownItem(tokchi, itemHTMLNode, resultItem) {
                    const preTokens = tokchi.getTokens().map(token => token.label).join(' ');

                    $(itemHTMLNode)
                        .text(preTokens + ' ' + resultItem.label)
                        .append($('<div>')
                        .addClass('sub')
                        .text('ID: ' + resultItem.id));
                },
                onUnwrapToken(tokchi, tokenHTMLNode, tokenObj) {
                    return tokenObj.label;
                },
                onSearchKeyword(tokchi, keyword, previousToken) {
                    $.getJSON('https://jsonplaceholder.typicode.com/comments', function(data) {
                        const results = data.slice(0, 20).filter(comment => comment.name.includes(keyword));
                        const skimmedData = results.map(item => {
                            return {
                                'id': item.id,
                                'label': item.name
                            };
                        });

                        tokchi.setSearchResult(skimmedData);
                    });
                }
            });
        });

        function setDDStyle (style) {
            tokchi.setDropdownStyle(style);
        }
    </script>
</head>

<body>
    <h1>Tokchi Keywords Demo</h1>
    <label for="search">Search </label>
    <div style="position:relative">
    	<div class="search" id="search"></div>
    </div>
    <label>Dropdown </label>
        <input id="fixed" type="radio" name="dd-type" value="fixed" onchange="setDDStyle(this.value)" /><label for="fixed">fixed</label>
        <input id="follows" type="radio" name="dd-type" value="follows" checked="checked" onchange="setDDStyle(this.value)" /><label for="follows">follows</label>
    <div id="selection" style="margin-top:50px"></div>
</body>